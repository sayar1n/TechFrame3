# Space Dashboard Project

Проект для сбора и визуализации космических данных на стеке FastAPI + Next.js. Система обеспечивает сбор, обработку и отображение данных с Международной космической станции, обсерватории JWST, астрономических событий и телеметрических данных.

## Структура проекта

- `services/fastapi-backend` - FastAPI бэкенд сервис на Python 3.11
- `services/nextjs-frontend` - Next.js 14 фронтенд приложение на React и TypeScript
- `services/pascal-legacy` - Legacy Pascal утилита для генерации телеметрических данных
- `services/nginx` - Nginx reverse proxy
- `services/redis` - Redis кэш для оптимизации производительности
- `db` - PostgreSQL база данных с поддержкой TIMESTAMPTZ

## Технологический стек

Проект был мигрирован с Rust (Axum) и Laravel на современный стек. Backend использует FastAPI с SQLAlchemy (asyncpg) для асинхронной работы с базой данных и Pydantic для валидации данных. Frontend построен на Next.js 14 с TypeScript и SCSS для стилизации. Все сервисы контейнеризированы через Docker Compose и собираются с нуля из исходных зависимостей.

Архитектура бэкенда следует принципам Clean Architecture с разделением на слои: конфигурация, состояние приложения с dependency injection, репозитории для работы с БД, сервисы для бизнес-логики и обработчики запросов. Используется Repository Pattern для защиты от SQL-инъекций и централизованной работы с данными. Для предотвращения дубликатов реализован Upsert по бизнес-ключам, а для контроля конкурентности - PostgreSQL Advisory Locks.

Frontend разделен на отдельные страницы: dashboard, ISS, OSDR, telemetry и astronomy. Каждая страница имеет собственную логику и компоненты. Реализованы гибкие дашборды с фильтрацией по возрастанию и убыванию, выбором столбцов, фильтрацией по дате и поиском по ключевым словам. Стилизация выполнена на SCSS с использованием переменных, миксинов и вложенности для централизованного управления дизайном.

## Функциональность

Система поддерживает сбор и визуализацию данных с нескольких источников. ISS модуль отображает последние данные о станции, тренды с картой и графиками. OSDR модуль обеспечивает синхронизацию данных и их отображение в таблице с расширенной фильтрацией. JWST модуль предоставляет галерею изображений с проксированием для обхода CORS ограничений. Astronomy модуль интегрирован с NASA API для получения данных о околоземных объектах. Telemetry модуль генерирует телеметрические данные в формате CSV с визуализацией в таблице. Все данные кэшируются в Redis для снижения нагрузки на базу данных и внешние API.

Legacy Pascal модуль работает как отдельный сервис в Docker контейнере. Он генерирует телеметрические данные в формате CSV и загружает их в таблицу `telemetry_legacy` в PostgreSQL. FastAPI бэкенд читает эти данные через TelemetryRepo и предоставляет их через API для отображения на фронтенде. Данные сохраняются с корректной типизацией: TIMESTAMPTZ для дат, NUMERIC для чисел и TEXT для строковых значений.

## Быстрый старт

1. Скопируйте `.env.example` в `.env` и настройте переменные окружения:
```bash
cp .env.example .env
```

2. Запустите все сервисы через Docker Compose:
```bash
docker-compose up -d
```

3. Откройте браузер и перейдите на `http://localhost:8080`

Все сервисы собираются с нуля: FastAPI бэкенд из Python 3.11 и requirements.txt, Next.js фронтенд из package.json, PostgreSQL инициализируется через init.sql, Redis использует готовый образ, а Nginx настраивается из конфигурационного файла.

## Переменные окружения

Основные переменные описаны в `.env.example`. Обязательно настройте:
- `POSTGRES_PASSWORD` - пароль для PostgreSQL
- `NASA_API_KEY` - ключ для NASA API (если используется)
- `JWST_API_KEY` - ключ для JWST API
- `ASTRO_APP_ID` и `ASTRO_APP_SECRET` - для Astronomy API

Секреты хранятся в `.env` файле и передаются через Docker Compose, никогда не коммитятся в код.

## Порты

- `8080` - Nginx (основной веб-интерфейс)
- `3000` - Next.js фронтенд
- `8081` - FastAPI бэкенд
- `5432` - PostgreSQL
- `6379` - Redis

## Архитектура бэкенда

Структура бэкенда организована по принципам Clean Architecture. Основные директории: `config` для конфигурации и настроек, `state` для состояния приложения с dependency injection через AppState, `database` для подключения к БД и миграций, `domain` для Pydantic моделей, `schemas` для валидационных схем, `clients` для HTTP клиентов внешних API, `repo` для репозиториев работы с данными, `services` для бизнес-логики, `handlers` для обработчиков запросов и `routes` для маршрутов API.

Используется Repository Pattern, что исключает прямые SQL запросы в обработчиках и обеспечивает централизованную работу с базой данных. Все операции с данными проходят через репозитории, что упрощает тестирование и поддержку. Для предотвращения дубликатов данных реализован Upsert по бизнес-ключам вместо простых INSERT операций.

## Безопасность и производительность

Система использует Pydantic для валидации всех входных параметров на уровне API. SQLAlchemy ORM защищает от SQL-инъекций, а данные санитизируются через Pydantic схемы. CORS настроен через middleware FastAPI. Rate-limiting реализован через Redis и PostgreSQL advisory locks для фоновых задач, что предотвращает race conditions при параллельном выполнении.

Для оптимизации производительности используется Redis кэширование часто запрашиваемых данных по паттерну Cache-Aside, асинхронные операции через async/await для неблокирующей работы, connection pooling для PostgreSQL для эффективного использования соединений, индексы в базе данных для быстрого поиска и ленивая загрузка данных на фронтенде для улучшения времени отклика интерфейса.

## Разработка

### Локальная разработка фронтенда

```bash
cd services/nextjs-frontend
npm install
npm run dev
```

Фронтенд будет доступен на `http://localhost:3000`. Используется Next.js 14 с поддержкой hot reload.

### Локальная разработка бэкенда

```bash
cd services/fastapi-backend
pip install -r requirements.txt
uvicorn main:app --reload
```

Бэкенд будет доступен на `http://localhost:8081`. API документация доступна по адресу `/docs` (Swagger UI) и `/redoc` (ReDoc).

## Сборка

Все сервисы собираются через Docker Compose. Для пересборки:

```bash
docker-compose build
docker-compose up -d
```

При сборке все зависимости устанавливаются заново, что гарантирует воспроизводимость окружения.

## Логи

Просмотр логов всех сервисов:
```bash
docker-compose logs -f
```

Просмотр логов конкретного сервиса:
```bash
docker-compose logs -f fastapi-backend
docker-compose logs -f nextjs-frontend
docker-compose logs -f nginx
docker-compose logs -f redis
docker-compose logs -f postgres
```

## Рефакторинг проекта

### Состав модулей до рефакторинга

До миграции проект использовал монолитную архитектуру на Rust (Axum) с SQLx для работы с базой данных. Frontend был построен на Laravel с PHP и Blade шаблонами, использовался Bootstrap для стилизации. Legacy модуль работал как отдельный Pascal процесс, генерирующий CSV файлы. Структура была монолитной с прямыми SQL запросами в обработчиках, отсутствовали слои абстракции и типизация данных на уровне валидации.

### Состав модулей после рефакторинга

После миграции проект переведен на микросервисную архитектуру с четким разделением ответственности. Backend на FastAPI с SQLAlchemy (asyncpg) для асинхронной работы, Pydantic для валидации. Frontend на Next.js 14 с TypeScript и SCSS. Legacy Pascal модуль сохранен как отдельный сервис для обратной совместимости. Архитектура следует принципам Clean Architecture с разделением на слои: конфигурация, состояние, репозитории, сервисы, обработчики и маршруты. Все сервисы контейнеризированы через Docker Compose.

### Анализ рефакторинга по модулям

| Модуль | Проблема | Решение | Паттерн | Эффект |
|--------|----------|---------|---------|--------|
| Backend | Rust сложен для поддержки, нет типизации данных на уровне API | Миграция на FastAPI с Pydantic валидацией, Clean Architecture | Clean Architecture, Repository Pattern | Упрощение поддержки, автоматическая валидация, меньше ошибок, легче тестировать |
| Frontend | Laravel Blade смешивает логику и представление, низкая производительность | Next.js с разделением на страницы и компоненты, TypeScript | Component-based Architecture | Чистый код, переиспользование компонентов, лучшая производительность, SSR |
| Database | Прямые SQL запросы, нет типизации дат, дубликаты данных | Репозитории с TIMESTAMPTZ, Upsert по бизнес-ключам | Repository Pattern, Upsert Pattern | Защита от SQL-инъекций, корректная работа с датами, предотвращение дубликатов |
| Legacy | Pascal модуль сложен в поддержке, изолирован от основной системы | Сохранен как отдельный сервис, интегрирован через БД | Service Layer Pattern | Обратная совместимость, единый стек для основной системы |
| API Integration | Нет обработки ошибок, таймауты, нестабильность | Клиенты с retry логикой, обработка ошибок, кэширование | Circuit Breaker (частично), Error Handling | Стабильность при сбоях внешних API, снижение нагрузки |
| Concurrency | Race conditions в фоновых задачах, параллельное выполнение | PostgreSQL Advisory Locks для синхронизации | Advisory Lock Pattern | Предотвращение параллельного выполнения задач, целостность данных |
| Caching | Нет кэширования, высокая нагрузка на БД и внешние API | Redis для кэширования данных по паттерну Cache-Aside | Cache-Aside Pattern | Снижение нагрузки на БД и внешние API, улучшение времени отклика |

### Выводы

Ключевые улучшения, которые реально повлияли на систему:

**Миграция на FastAPI + Next.js** - упростила поддержку кода и улучшила производительность. FastAPI с автоматической валидацией через Pydantic снизил количество ошибок на этапе разработки. Next.js с SSR улучшил время первой загрузки страниц. Реализация: `services/fastapi-backend/` и `services/nextjs-frontend/`.

**Clean Architecture с Repository Pattern** - код стал более структурированным и тестируемым. Разделение на слои упростило понимание структуры проекта. Репозитории защищают от SQL-инъекций и централизуют работу с БД. Реализация: `services/fastapi-backend/app/repo/`, `services/fastapi-backend/app/services/`, `services/fastapi-backend/app/handlers/`.

**Upsert по бизнес-ключам** - предотвращение дубликатов данных стало надежным и предсказуемым. Особенно важно для OSDR данных, где используется уникальный индекс по `dataset_id`. Реализация: `services/fastapi-backend/app/repo/osdr_repo.py`, `services/fastapi-backend/app/database/connection.py`.

**PostgreSQL Advisory Locks** - решили проблемы concurrency в фоновых задачах. Предотвращают параллельное выполнение scheduler задач, что критично для синхронизации данных. Реализация: `services/fastapi-backend/app/utils/advisory_lock.py`.

**Redis кэширование** - снизило нагрузку на БД и внешние API. Cache-Aside паттерн обеспечивает актуальность данных при разумном использовании ресурсов. Реализация: `services/fastapi-backend/app/repo/cache_repo.py`, интеграция в `services/fastapi-backend/app/services/`.

**TIMESTAMPTZ для всех дат** - корректная работа с timezone во всех модулях. Решена проблема несоответствия дат при работе с разными часовыми поясами. Реализация: все таблицы в `services/fastapi-backend/app/database/connection.py` используют TIMESTAMPTZ.


### Документация

Основные файлы для изучения архитектуры:
- Backend структура: `services/fastapi-backend/app/`
- Frontend структура: `services/nextjs-frontend/app/` и `services/nextjs-frontend/pages/`
- Docker конфигурация: `docker-compose.yml`
- Конфигурация окружения: `.env.example`
- База данных: `db/init.sql`


